library(shiny)
library(shinydashboard)
library(data.table)
library(ggplot2)
library(shinyTree)
library(shiny.i18n)
library(DT)
i18n <- Translator$new(translation_csvs_path = "./translations/")
i18n$set_translation_language("fa")

app_server <- function(input, output,session) {
    # List the first level callModules here

    output$treeExp <- renderTree({
        list(
            G01 = list(
                G011 = list(
                    G0111 = list(
                        G01111 = list(
                            I011111="011111",
                            I011112="011112",
                            I011113="011113",
                            I011114="011114",
                            I011115="011115",
                            I011116="011116",
                            I011117="011117",
                            I011118="011118"
                        ),
                        G01112 = list(
                          I011121="011121",
                          I011122="011122",
                          I011123="011123",
                          I011124="011124",
                          I011125="011125"
                        ),
                        G01114 = list(
                            I011141="011141",
                            I011142="011142",
                            I011143="011143",
                            I011144="011144"
                        ),
                        G01115 = list(
                          I011151="011151",
                          I011152="011152",
                          I011153="011153",
                          I011154="011154",
                          I011155="011155",
                          I011156="011156"
                        ),
                        G01116= list(
                          I011161="011161",
                          I011162="011162",
                          I011163="011163",
                          I011164="011164",
                          I011165="011165",
                          I011166="011166"
                        ),
                        G01117=list(
                          I011171="011171",
                          I011172="011172",
                          I011173="011173",
                          I011174="011174",
                          I011175="011175"
                        )
                    ),
                    G0112 = list(
                      G01121 = list(
                        I011211="011211",
                        I011212="011212",
                        I011213="011213",
                        I011214="011214",
                        I011215="011215",
                        I011216="011216",
                        I011217="011217",
                        I011218="011218"
                         ),
                      G01122 = list(
                        I011221="011221",
                        I011222="011222",
                        I011223="011223",
                        I011224="011224"
                        ),
                      G01123= list(
                        I011231="011231",
                        I011232="011232",
                        I011233="011233",
                        I011234="011234",
                        I011235="011235",
                        I011236="011236",
                        I011237="011237",
                        I011238="011238",
                        I011239="011239"
                      ),
                      G01124=list(
                        I011241="011241",
                        I011244="011244",
                        I011247="011247"
                      )
                    ),
                    G0113 = list(
                      G01131 = list(
                        I011311="011311",
                        I011312="011312",
                        I011313="011313",
                        I011314="011314",
                        I011315="011315",
                        I011316="011316",
                        I011317="011317",
                        I011318="011318",
                        I011319="011319"
                      ),
                      G01132 = list(
                        I011321="011321"
                      )
                    ),
                    G0114 = list(
                      G01141 = list(
                        I011411="011411",
                        I011412="011412",
                        I011413="011413",
                        I011414="011414"
                      ),
                      G01142 = list(
                        I011421="011421",
                        I011422="011422",
                        I011423="011423",
                        I011424="011424",
                        I011425="011425",
                        I011426="011426",
                        I011427="011427",
                        I011428="011428",
                        I011429="011429"
                      ),
                      G01143= list(
                        I011431="011431",
                        I011432="011432",
                        I011433="011433",
                        I011434="011434"
                      ),
                      G01144=list(
                        I011441="011441",
                        I011442="011442",
                        I011443="011443"
                      )
                    ),
                    G0115=list(
                      G01151 = list(
                        I011511="011511",
                        I011512="011512"
                      ),
                      G01152 = list(
                        I011521="011521",
                        I011522="011522",
                        I011523="011523"
                      ),
                      G01153= list(
                        I011531="011531",
                        I011532="011532",
                        I011533="011533"
                      )
                    ),
                    G0116=list(
                      G01161 = list(
                        I011611="011611",
                        I011612="011612",
                        I011613="011613",
                        I011614="011614",
                        I011615="011615",
                        I011616="011616",
                        I011617="011617",
                        I011618="011618",
                        I011619="011619"
                      ),
                      G01162 = list(
                        I011621="011621",
                        I011622="011622",
                        I011623="011623",
                        I011624="011624",
                        I011625="011625"
                      ),
                      G01163= list(
                        I011631="011631",
                        I011632="011632",
                        I011633="011633",
                        I011634="011634",
                        I011635="011635"
                      ),
                      G01164 = list(
                        I011641="011641",
                        I011642="011642",
                        I011643="011643"
                      ),
                      G01165 = list(
                        I011651="011651",
                        I011652="011652",
                        I011653="011653",
                        I011654="011654",
                        I011655="011655",
                        I011656="011656",
                        I011657="011657",
                        I011658="011658",
                        I011659="011659"
                      ),
                      G01166= list(
                        I011661="011661",
                        I011662="011662",
                        I011663="011663",
                        I011664="011664",
                        I011665="011665",
                        I011666="011666",
                        I011667="011667",
                        I011668="011668",
                        I011669="011669"
                      )
                    ),
                    G0117=list(
                      G01171 = list(
                        I011711="011711",
                        I011712="011712",
                        I011713="011713",
                        I011714="011714",
                        I011715="011715",
                        I011716="011716"
                      ),
                      G01172 = list(
                        I011721="011721",
                        I011722="011722",
                        I011723="011723",
                        I011724="011724",
                        I011725="011725",
                        I011726="011726",
                        I011727="011727"
                      ),
                      G01173= list(
                        I011731="011731",
                        I011732="011732",
                        I011733="011733",
                        I011734="011734",
                        I011735="011735"
                      ),
                      G01174 = list(
                        I011741="011741",
                        I011742="011742"
                      ),
                      G01175 = list(
                        I011751="011751",
                        I011752="011752",
                        I011753="011753",
                        I011754="011754"
                      ),
                      G01176= list(
                        I011761="011761",
                        I011762="011762",
                        I011763="011763",
                        I011764="011764",
                        I011765="011765",
                        I011766="011766",
                        I011767="011767",
                        I011768="011768",
                        I011769="011769"
                      )
                    ),
                    G0118=list(
                      G01181 = list(
                        I011811="011811",
                        I011812="011812"
                      ),
                      G01182 = list(
                        I011821="011821",
                        I011822="011822",
                        I011823="011823"
                      ),
                      G01183= list(
                        I011831="011831",
                        I011832="011832",
                        I011833="011833",
                        I011834="011834",
                        I011835="011835",
                        I011838="011838",
                        I011839="011839"
                      ),
                      G01184 = list(
                        I011841="011841",
                        I011842="011842",
                        I011843="011843",
                        I011844="011844",
                        I011845="011845"
                      )
                    ),
                    G0119=list(
                      G01191 = list(
                        I011911="011911",
                        I011912="011912",
                        I011913="011913",
                        I011914="011914",
                        I011915="011915",
                        I011916="011916",
                        I011917="011917",
                        I011918="011918",
                        I011919="011919"
                      ),
                      G01192 = list(
                        I011921="011921",
                        I011922="011922",
                        I011923="011923",
                        I011924="011924",
                        I011925="011925",
                        I011926="011926",
                        I011927="011927",
                        I011928="011928",
                        I011929="011929"
                      ),
                      G01193= list(
                        I011931="011931",
                        I011933="011933",
                        I011934="011934",
                        I011935="011935",
                        I011936="011936"
                      ),
                      G01194 = list(
                        I011945="011945",
                        I011946="011946",
                        I011947="011947"
                      )
                    )
                ),
                G012=list(
                  G0121 = list(
                    G01211 = list(
                      I012111="012111",
                      I012112="012112",
                      I012113="012113",
                      I012114="012114"
                    )
                    ),
                    G0122 = list(
                    G01221 = list(
                      I011221="011221",
                      I011222="011222",
                      I011223="011223",
                      I011224="011224",
                      I011225="011225",
                      I011216="011226",
                      I011218="011228"
                )
                    )
                )
            ),
            G02=list(
              G021=list(
                G0211 = list(
                  G02111 = list(
                    I012111="021111"
                  )
                )
              ),
              G022=list(
                G0221 = list(
                  G02211 = list(
                    I022111="022111",
                    I022113="022113",
                    I022115="022115"
                  )
                )
              ),
              G023=list(
                G0223 = list(
                  G02231 = list(
                    I022311="022311"
                  )
                )
              )
        ),
            G03="G03",
            G04="G04",
            G05="G05",
            G06="G06",
            G07="G07",
            G08="G08",
            G09="G09",
            G10="G10",
            G11="G11",
            G12="G12"
        )
    })

    output$sel_names <- renderPrint({
        tree <- input$treeExp
        req(tree)
        get_selected(tree)
    })
    output$sel_slices <- renderPrint({
        tree <- input$treeExp
        req(tree)
        get_selected(tree, format = "slices")
    })
    output$sel_classid <- renderPrint({
        tree <- input$treeExp
        req(tree)
        get_selected(tree, format = "classid")
    })
    output$tblT2Stats <- renderDataTable({
        y <- input$slcT2Year
        vs <- input$slcT2Var
        gs <- input$slcT2Grp
        st <- input$slcT2Stat

        fn <- paste0("data/Y",substr(y,3,4),"MergedData.rda")
        load(fn)

        fnc <- get(st)
        vss <- vs
        for(v in names(MergedData)){
            vss[vss==i18n$t(v)]=v
        }
        SD <- MergedData[,lapply(.SD,fnc), by=gs,.SDcols=vss]
        setnames(SD,vss,vs)
        SD
    })

    output$pltT2barchart <- renderPlot({

        y <- input$slcT2Year
        vs <- input$slcT2Var
        gs <- input$slcT2Grp
        st <- input$slcT2Stat

        fn <- paste0("data/Y",substr(y,3,4),"MergedData.rda")
        load(fn)

        fnc <- get(st)

        vs[vs==i18n$t("HLiterate")]="HLiterate"
        SD <- MergedData[,lapply(.SD,fnc), by=gs,.SDcols=vs]

        if(length(gs)>1){
            SD[,NewVar:=do.call(paste0,.SD),.SDcols=gs]
            ggplot(SD) +  geom_col(aes_string(x="NewVar",y=vs))

        }else{
            ggplot(SD) +  geom_col(aes_string(x=gs,y=vs))

        }
    })

    session$onSessionEnded(function() {
            stopApp()
        #    q("no")
    })

}
